// Simple Inventory, for SugarCube 2, by Chapel
// v3.0.0, 2021-04-15, 71f99dd0c28d545b688b0c8e57f672a0c1970301
;(()=>{"use strict";const t={description:"",handler:null,name:"",consumable:!0,unique:!1},e=new Map;class i{constructor(e="",i=clone(t),n=[]){if(!e||"string"!=typeof e)throw new Error("invalid item ID");if("object"!=typeof i)throw new Error("invalid item definition");Object.assign(this,Object.assign(t,i)),this.id=e,this.tags=n instanceof Array?n:"string"==typeof n?[n]:[]}static emit(t,e){$(document).trigger({type:(":"===t[0]?t:":"+t)+".simple-inventory",item:e})}static is(t){return t instanceof i}static add(t,n,s){const r=new i(t,n,s);return e.set(t,r),r}static get(t){return e.get(t)}static has(t){return e.has(t)}static get list(){return e}emit(t){return i.emit(t,this),this}get name(){return this.name||this.id}use(){return"string"==typeof this.handler?$.wiki(this.handler):"function"==typeof this.handler&&this.handler(this),this.emit("use"),this}inspect(){Dialog.setup(this.name(),"simple-inventory item-description"),Dialog.wiki(this.description),Dialog.open()}}Macro.add(["item","consumable"],{tags:["description","tags","unique"],handler(){let t,e,n,s,r=null,a=!1,o=!1;if(State.length>0)return this.error("items must be defined in `StoryInit` or story JavaScript!");if(!this.args[0]||"string"!=typeof this.args[0]||!this.args[0].trim())return this.error("invalid item ID");if(t=this.args[0].trim(),"consumable"===this.name&&(r=this.payload[0].contents||null,a=!0),this.args[1]&&(e=this.args[1].trim()),this.payload.length>1){const t=this.payload.find((t=>"descripion"===t.name)),e=this.payload.find((t=>"tags"===t.name)),i=this.payload.find((t=>"unique"===t.name));t&&(n=t.contents),e&&(s=e.args.flat(1/0)),i&&(o=!0)}i.add(t,{name:e||"",description:n||"",handler:r,consumable:a,unique:o},s)}}),setup.Item=i,window.Item=window.Item||i})(),(()=>{"use strict";const t=[":use",":pick-up",":drop",":transfer"];class e{constructor(t={},e=[]){this.data=clone(t),this.tags=e instanceof Array?e:"string"==typeof e?[e]:[]}static change(t,i,n=1,s=!1){if(0!==n){if(s&&(n*=-1),t instanceof e&&(t=t.data),"object"!=typeof t){if(t)throw new TypeError("cannot access inventory data");t={}}if(!(r=i)||"string"!=typeof r||!r.trim())throw new TypeError("invalid item name/id");var r;if("number"==typeof n&&!Number.isNaN(n)&&Number.isInteger(n)||(n=1),!Object.keys(t).includes(i)||!function(t){return Item.has(t)&&Item.get(t).unique}(i))return n>0?(Object.keys(t).includes(i)||(t[i]=0),t[i]+=n):(Object.keys(t).includes(i)&&"number"==typeof t[i]&&(t[i]-=n),t[i]<=0&&delete t[i]),t}}static is(t){return t instanceof e}static emit(t,e,i=null){$(document).trigger({type:(":"===t[0]?t:":"+t)+".simple-inventory",inventory:e,target:i})}static add(t,i){return new e(t,i)}emit(t,i=null){return e.emit(t,this,i),this}get array(){const t=[];return Object.keys(this.data).forEach((e=>{if(t.push(e),this.data[e]>1)for(var i=1;i<this.data[e];i++)t.push(e)})),t}get list(){return Object.keys(this.data)}get length(){return this.array.length}get uniqueLength(){return this.list.length}get table(){return this.data}count(t){return t?this.data[t]||0:this.length}has(t,e=1){return this.data[t]>=e}hasAll(){const t=this;return[].slice.call(arguments).flat(1/0).every((e=>t.has(e)))}pickUp(t,i){return e.change(this,t,i)&&this.emit("pick-up"),this}drop(t,i){return e.change(this,t,i,!0)&&this.emit("drop"),this}transfer(t,i,n){if(!e.is(t))throw new TypeError("target inventory is not an inventory instance");if(this.has(i)){const s=e.change(this,i,n,!0),r=e.change(t,i,n);(s||r)&&this.emit("transfer")}return this}iterate(t){return"function"!=typeof t||this.list.forEach((e=>{t(e,this.data[e])})),this}use(t){if(!Item.has(t))return;const i=Item.get(t);return i.use(),i.consumable&&e.change(this,i,1,!0),this.emit("use"),this}inspectLink(t,e="Inspect",i=!1){return $(document.createElement(i?"button":"a")).addClass("inspect-link","simple-inventory").wiki(e).ariaClick((()=>{Item.get(t).inspect()}))}useLink(t,e="Use",i=!1){const n=this;return $(document.createElement(i?"button":"a")).addClass("use-link","simple-inventory").wiki(e).ariaClick((()=>{n.use(t)}))}dropLink(t,i,n=!1,s=null){const r=this;return $(document.createElement(n?"button":"a")).addClass("drop-link","simple-inventory").wiki(i||s?"Give":"Drop").ariaClick((()=>{s&&e.is(s)?r.transfer(s,t):r.drop(t)}))}itemCount(t,e="'(&times;'",i=")"){return $(document.createElement("span")).addClass("item-count","simple-inventory").append(""+e+(this.count(t)||0)+i)}displayInventoryList(t={description:!0,use:!0,transfer:null,drop:!0}){const e=this,i=$(document.createElement("ul")).addClass("simple-inventory-list"),n=this.list.map((i=>{const n=[];return t.description&&Item.has(i)&&Item.get(i).description?n.push(e.inspectLink(i,Item.has(i)?Item.get(i).name:i)):n.push($(document.createElement("span")).append(Item.has(i)?Item.get(i).name:i).addClass("item-name")),n.push(e.itemCount(i)),t.use&&n.push(e.useLink(i)),(t.transfer||t.drop)&&e.dropLink(i,"",!1,t.target),$(document.createElement("li")).append(n).addClass("simple-inventory-listing")}));return i.append(n),i}interface(e={},i=null){const n=$(document.createElement("div")).addClass("simple-inventory-wrapper");n.append(this.displayInventoryList(e));const s=t.map((t=>t+".gui-chapel-simple-inv")).join(", ");let r;return $(document).on(s,(()=>{n.length?n.empty().append(this.displayInventoryList(e)):$(document).off(s)})),!i||i instanceof $?i&&(r=$(i)):r=i,r&&r.append(n),n}clone(){return new e(this.data||{},this.tags||[])}toJSON(){return JSON.reviveWrapper("new setup.Inventory("+JSON.stringify(this.data)+", "+JSON.stringify(this.tags)+")")}}function i(t){return t&&"string"==typeof t&&t.length>2&&("$"===t[0]||"_"===t[0])}function n(t){if(i(t)&&(t=State.getVar(t)),e.is(t))return t}Macro.add("newinv",{handler(){if(!i(this.args[0]))return this.error("argument must be the quoted name of a story variable or temporary variable!");State.setVar(this.args[0],new e({},this.args.flat(1/0).slice(1)))}}),Macro.add("pickup",{handler(){const t=n(this.args[0]);if(!t)return this.error("first argument must be a valid inventory!");t.pickUp(this.args[1],this.args[2])}}),Macro.add("drop",{handler(){const t=n(this.args[0]);if(!t)return this.error("first argument must be a valid inventory!");t.drop(this.args[1],this.args[2])}}),Macro.add("transfer",{handler(){const t=n(this.args[0]);if(!t)return this.error("first argument must be a valid inventory!");const e=n(this.args[1]);if(!e)return this.error("second argument must be a valid inventory!");t.transfer(e,this.args[2],this.args[3])}}),Macro.add("inv",{handler(){let t;const e=n(this.args[0]);if(!e)return this.error("first argument must be a valid inventory!");this.args[1]&&(t=n(this.args[1]));const i={description:this.args.includesAny("inspect","description"),use:this.args.includes("use"),transfer:t,drop:this.args.includes("drop")};e.interface(i,this.output)}}),setup.Inventory=e,window.Inventory=window.Inventory||e})();
// End Simple Inventory
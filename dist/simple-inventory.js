// Simple Inventory, for SugarCube 2, by Chapel
// v3.0.0-pa2, 2021-04-16, 91276b70731cd5e04222cf6d71705924facd9267
;(()=>{"use strict";const t={description:"",handler:null,displayName:"",consumable:!0,unique:!1,permanent:!1},e=new Map;class n{constructor(e="",n=clone(t),s=[]){if(!e||"string"!=typeof e)throw new Error("invalid item ID");if("object"!=typeof n)throw new Error("invalid item definition");Object.assign(this,Object.assign(t,n)),this.id=e,this.tags=s instanceof Array?s:"string"==typeof s?[s]:[]}static is(t){return t instanceof n}static add(t,s,i){const r=new n(t,s,i);return e.set(t,r),r}static get(t){return e.get(t)}static has(t){return e.has(t)}static get list(){return e}get name(){return this.displayName||this.id}set name(t){this.displayName=t}use(){return"string"==typeof this.handler?$.wiki(this.handler):"function"==typeof this.handler&&this.handler(this),this}inspect(){Dialog.setup(this.name,"simple-inventory item-description"),Dialog.wiki(this.description),Dialog.open()}}setup.Item=n,window.Item=window.Item||n})(),(()=>{"use strict";const t=setup.Item;let e="all",n="&hellip;";class s{constructor(t={},e=[]){this.data=clone(t),this.tags=e instanceof Array?e:"string"==typeof e?[e]:[]}static get confirm(){return e}static set confirm(t){e="string"==typeof t&&"all"===t.trim().toLowerCase()?"all":!!t}static get emptyMessage(){return n}static set emptyMessage(t){"string"==typeof t&&(n=t)}static change(e,n,i=1,r=!1){if(0!==i){if(e instanceof s&&(e=e.data),"object"!=typeof e){if(e)throw new TypeError("cannot access inventory data");e={}}if(!(a=n)||"string"!=typeof a||!a.trim())throw new TypeError("invalid item name/id");var a;if("number"==typeof i&&!Number.isNaN(i)&&Number.isInteger(i)||(i=1),r&&(i*=-1),i>0){if(Object.keys(e).includes(n)&&function(e){return t.has(e)&&t.get(e).unique}(n))return;Object.keys(e).includes(n)||(e[n]=0),e[n]+=i}else{if(function(e){return t.has(e)&&t.get(e).permanent}(n))return;Object.keys(e).includes(n)&&"number"==typeof e[n]&&(e[n]+=i),e[n]<=0&&delete e[n]}return e}}static itemset(t={}){if(s.is(t)&&(t=t.data),"object"!=typeof t)return{};const e={};return Object.keys(t).forEach((n=>{"number"==typeof t[n]&&Number.isInteger(t[n])&&0!==t[n]&&(e[n]=t[n])})),e}static parseArgList(){const t=[].slice.call(arguments).flat(1/0);if(t.length%2!=0)throw new Error("item sets should be pairs of item IDs and numbers");var e={};return t.forEach((function(n,s){s%2==0&&(e[n]=t[s+1])})),e}static is(t){return t instanceof s}static emit(t,e,n={}){$(document).trigger(Object.assign({type:":inventory-"+t+".simple-inventory",inventory:e,target:null,delta:{},item:null},n))}static create(t,e){return new s(t,e)}emit(t,e={}){return s.emit(t,this,e),this}get array(){const t=[];return Object.keys(this.data).forEach((e=>{if(t.push(e),this.data[e]>1)for(var n=1;n<this.data[e];n++)t.push(e)})),t}get list(){return Object.keys(this.data)}get length(){return this.array.length}get uniqueLength(){return this.list.length}get table(){return this.data}count(t){return t?this.data[t]||0:this.length}has(t,e=1){return this.data[t]>=e}hasAll(){const t=this;return[].slice.call(arguments).flat(1/0).every((e=>t.has(e)))}hasAny(){const t=this;return[].slice.call(arguments).flat(1/0).some((e=>t.has(e)))}merge(t){const e=this,n=s.itemset(t);return Object.keys(n).forEach((t=>{s.change(e,t,n[t])})),t}unmerge(t){const e=this,n={},i=s.itemset(t);return Object.keys(i).forEach((t=>{e.has(t,i[t])?n[t]=i[t]:e.has(t)&&(n[t]=e.count(t)),s.change(e,t,i[t],!0)})),n}pickup(){const t=this.merge(s.parseArgList.apply(null,arguments));return this.emit("update",{delta:t}),this}drop(){const t=this.unmerge(s.parseArgList.apply(null,arguments));return this.emit("update",{delta:t}),this}empty(){const t=clone(this.data);this.data={},this.emit("update",{delta:t})}transfer(t){const e=s.parseArgList.apply(null,[].slice.call(arguments).slice(1));if(!s.is(t))throw new TypeError("target inventory is not an inventory instance");const n=this.unmerge(e);return t.merge(n),this.emit("update",{target:t,delta:n}),this}isEmpty(){return 0===this.length}iterate(t){return"function"!=typeof t||this.list.forEach((e=>{t(e,this.data[e])})),this}use(e){if(!t.has(e))return;const n=t.get(e);if(n.use(),n.consumable){s.change(this,e,1,!0);const t={};t[e]=1,this.emit("update",{delta:t})}return this.emit("use",{item:n}),this}clone(){return new s(this.data||{},this.tags||[])}toJSON(){return JSON.reviveWrapper("new setup.Inventory("+JSON.stringify(this.data)+", "+JSON.stringify(this.tags)+")")}}setup.Inventory=s,window.Inventory=window.Inventory||s})(),(()=>{"use strict";const t=setup.Item,e=setup.Inventory;function n(t=null,n=null,s=!1,i="Alert",r="Are you sure?"){if(!e.confirm&&t&&"function"==typeof t)return void t();if("all"===e.confirm&&!s)return void t();const a={display:"inline-block",float:"right"},o=$(document.createElement("div")),l=$(document.createElement("p")).append(r),c=$(document.createElement("div")).addClass("confirmation-buttons"),u=$(document.createElement("button")).append("Okay").addClass("confirm-yes").css(Object.assign(a,{"margin-right":"0.5rem"})),d=$(document.createElement("button")).append("Cancel").addClass("confirm-no").css(a);t&&"function"==typeof t&&u.ariaClick(t),n&&"function"==typeof n&&d.ariaClick(n),c.append(d,u),o.append(l,c),Dialog.setup(i,"simple-inventory confirmation"),Dialog.append(o),Dialog.open()}function s(t){const e=$(document.createElement("span")).addClass("spacer");return t&&e.wiki(t),e}function i(t,s,i=!1,r=null){return $(document.createElement(i?"button":"a")).addClass("all-link drop-link").wiki((s||(r?"Give":"Drop"))+" all").ariaClick((()=>{t.isEmpty()||n((()=>{r&&e.is(r)?(r.merge(t),t.empty()):t.empty(),Dialog.close()}),(()=>{Dialog.close()}),!0)}))}function r(r,a={description:!0,use:!0,transfer:null,drop:!0,all:!0,dropActionText:"",classes:""}){const o=$(document.createElement("ul")).addClass("simple-inventory-list");let l;if(r.length){if(l=r.list.map((i=>{const o=[];return a.description&&t.has(i)&&t.get(i).description?o.push(function(e,n,s="Inspect",i=!1){return $(document.createElement(i?"button":"a")).addClass("inspect-link").wiki(s).ariaClick((()=>{t.get(n).inspect()}))}(0,i,t.has(i)?t.get(i).name:i)):o.push($(document.createElement("span")).append(t.has(i)?t.get(i).name:i).addClass("item-name")),o.push(function(t,e,n="&nbsp;&times;&nbsp;",s="&nbsp;"){return $(document.createElement("span")).addClass("item-count").append(""+n+(t.count(e)||0)+s)}(r,i)),a.use&&t.has(i)&&t.get(i).handler?o.push(function(t,e,n="Use",s=!1){return $(document.createElement(s?"button":"a")).addClass("use-link").wiki(n).ariaClick((()=>{t.use(e)}))}(r,i)):o.push(s()),(a.transfer&&e.is(a.transfer)||a.drop)&&!function(e){return t.has(e)&&t.get(e).permanent}(i)?o.push(function(t,s,i,r=!1,a=null){return $(document.createElement(r?"button":"a")).addClass("drop-link").wiki(i||(a?"Give":"Drop")).ariaClick((()=>{n((()=>{a&&e.is(a)?t.transfer(a,s,1):t.drop(s,1),Dialog.close()}),(()=>{Dialog.close()}))}))}(r,i,a.dropActionText,!1,a.target||null)):o.push(s()),$(document.createElement("li")).append(o).addClass("simple-inventory-listing")})),a.all){const t=$(document.createElement("li")).addClass("all-listing simple-inventory-listing").append([s("&mdash;"),s(),s(),i(r,a.dropActionText,!1,a.target||null)]);l.push(t)}}else l=$(document.createElement("li")).addClass("simple-inventory-listing").append($(document.createElement("span")).wiki(e.emptyMessage));return o.append(l),o}e.prototype.interface=function(t={},e=null){const n=this,s=$(document.createElement("div")).addClass("simple-inventory-wrapper");let i;return s.append(r(this,t)),$(document).on(":inventory-update.simple-inventory.gui-built-in",(()=>{s.length?s.empty().append(r(n,t)):$(document).off(":inventory-update.simple-inventory.gui-built-in")})),e&&e instanceof $?i=e:e&&(i=$(e)),i&&s.appendTo(i),s}})(),(()=>{"use strict";setup.Inventory,setup.Item;const t=".simple-inventory-userland",e=":inventory-update.simple-inventory"+t,n=":inventory-use.simple-inventory"+t;function s(t){return t&&"function"==typeof t}Object.assign(setup.Inventory,{events:{update:{on(t=null,n=""){s(t)&&$(document).on(e+n,t)},one(t=null,n=""){s(t)&&$(document).one(e+n,t)},off(t=""){$(document).off(e+t)}},use:{on(t=null,e=""){s(t)&&$(document).on(n+e,t)},one(t=null,e=""){s(t)&&$(document).one(n+e,t)},off(t=""){$(document).off(n+t)}}}})})(),(()=>{"use strict";const t=setup.Item,e=setup.Inventory;function n(t){return t&&"string"==typeof t&&t.length>2&&("$"===t[0]||"_"===t[0])}function s(t){if(n(t)&&(t=State.getVar(t)),e.is(t))return t}Macro.add(["item","consumable"],{tags:["description","tags","unique","permanent"],handler(){let e,n,s,i,r=null,a=!1,o=!1,l=!1;if(State.length>0)return this.error("items must be defined in `StoryInit` or story JavaScript!");if(!this.args[0]||"string"!=typeof this.args[0]||!this.args[0].trim())return this.error("invalid item ID");if(e=this.args[0].trim(),"consumable"===this.name&&(r=this.payload[0].contents||null,a=!0),this.args[1]&&(n=this.args[1]),this.payload.length>1){const t=this.payload.find((t=>"description"===t.name)),e=this.payload.find((t=>"tags"===t.name)),n=this.payload.find((t=>"unique"===t.name)),r=this.payload.find((t=>"permanent"===t.name));t&&(s=t.contents),e&&(i=e.args.flat(1/0)),n&&(o=!0),r&&(l=!0)}t.add(e,{displayName:n||"",description:s||"",handler:r,consumable:a,unique:o,permanent:l},i)}}),Macro.add("newinv",{handler(){const t=this.args.raw.trim().split(" ").first().replace(/["']/g,"").trim();if(!n(t))return this.error("argument must be a story or temporary variable!");State.setVar(t,new e({},this.args.flat(1/0).slice(1)))}}),Macro.add(["pickup","drop"],{handler(){const t=s(this.args[0]);return t?this.args.length<3?this.error("no items to pick up were provided"):void t[this.name](this.args.slice(1)):this.error("first argument must be a valid inventory!")}}),Macro.add("dropall",{handler(){const t=s(this.args[0]);if(!t)return this.error("first argument must be a valid inventory!");t.empty()}}),Macro.add(["transfer","merge","unmerge"],{handler(){const t=s(this.args[0]);if(!t)return this.error("first argument must be a valid inventory!");const e=s(this.args[1]);if(!e)return this.error("second argument must be a valid inventory!");if("transfer"===this.name){if(this.args.length<4)return this.error("no items to transfer were provided");t.transfer(e,this.args.slice(2))}else t[this.name](e)}}),Macro.add(["inv","take","give"],{handler(){let t=null;const e=s(this.args[0]);if(!e)return this.error("first argument must be a valid inventory!");this.args[1]&&s(this.args[1])&&(t=s(this.args[1]));const n={description:this.args.includesAny("inspect","description"),use:this.args.includes("use"),transfer:t,drop:this.args.includes("drop"),all:this.args.includes("all"),dropActionText:"inv"===this.name?"Drop":this.name.toUpperFirst(),classes:`macro-${this.name}`};e.interface(n,$(this.output))}})})(),(()=>{"use strict";const t=setup.Item,e=setup.Inventory;function n(t,e,n){if("object"!=typeof e)throw new TypeError("the extension should be a plain generic object holding the properties and methods you want to add");Object.keys(e).forEach((s=>{if(t[s]&&!n)throw new Error('Cannot override existing property "'+s+'"!');t[s]=e[s]}))}Object.assign(e,{extend(t,s=!1){n(e,t,s)},extendPrototype(t,s=!1){n(e.prototype,t,s)}}),Object.assign(t,{extend(e,s=!1){n(t,e,s)},extendPrototype(e,s=!1){n(t.prototype,e,s)}})})();
// End Simple Inventory
// Simple Inventory, for SugarCube 2, by Chapel
// v3.0.0-pa2, 2021-04-16, fb2d04dac85f9a884a9e7856743cef498974ff41
;"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}!function(){var e={description:"",handler:null,displayName:"",consumable:!0,unique:!1,permanent:!1},t=new Map,n=function(){function n(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:clone(e),r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(_classCallCheck(this,n),!t||"string"!=typeof t)throw new Error("invalid item ID");if("object"!==_typeof(i))throw new Error("invalid item definition");Object.assign(this,Object.assign(e,i)),this.id=t,this.tags=r instanceof Array?r:"string"==typeof r?[r]:[]}return _createClass(n,[{key:"name",get:function(){return this.displayName||this.id},set:function(e){this.displayName=e}},{key:"use",value:function(){return"string"==typeof this.handler?$.wiki(this.handler):"function"==typeof this.handler&&this.handler(this),this}},{key:"inspect",value:function(){Dialog.setup(this.name,"simple-inventory item-description"),Dialog.wiki(this.description),Dialog.open()}}],[{key:"is",value:function(e){return e instanceof n}},{key:"add",value:function(e,i,r){var a=new n(e,i,r);return t.set(e,a),a}},{key:"get",value:function(e){return t.get(e)}},{key:"has",value:function(e){return t.has(e)}},{key:"list",get:function(){return t}}]),n}();setup.Item=n,window.Item=window.Item||n}(),function(){var e=setup.Item,t="all",n="&hellip;";function i(t){return e.has(t)&&e.get(t).unique}function r(t){return e.has(t)&&e.get(t).permanent}function a(e){return e&&"string"==typeof e&&e.trim()}var o=function(){function o(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];_classCallCheck(this,o),this.data=clone(e),this.tags=t instanceof Array?t:"string"==typeof t?[t]:[]}return _createClass(o,[{key:"emit",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return o.emit(e,this,t),this}},{key:"array",get:function(){var e=this,t=[];return Object.keys(this.data).forEach((function(n){if(t.push(n),e.data[n]>1)for(var i=1;i<e.data[n];i++)t.push(n)})),t}},{key:"list",get:function(){return Object.keys(this.data)}},{key:"length",get:function(){return this.array.length}},{key:"uniqueLength",get:function(){return this.list.length}},{key:"table",get:function(){return this.data}},{key:"count",value:function(e){return e?this.data[e]||0:this.length}},{key:"has",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return this.data[e]>=t}},{key:"hasAll",value:function(){var e=this,t=[].slice.call(arguments).flat(1/0);return t.every((function(t){return e.has(t)}))}},{key:"hasAny",value:function(){var e=this,t=[].slice.call(arguments).flat(1/0);return t.some((function(t){return e.has(t)}))}},{key:"merge",value:function(e){var t=this,n=o.itemset(e);return Object.keys(n).forEach((function(e){o.change(t,e,n[e])})),e}},{key:"unmerge",value:function(e){var t=this,n={},i=o.itemset(e);return Object.keys(i).forEach((function(e){t.has(e,i[e])?n[e]=i[e]:t.has(e)&&(n[e]=t.count(e)),o.change(t,e,i[e],!0)})),n}},{key:"pickup",value:function(){var e=this.merge(o.parseArgList.apply(null,arguments));return this.emit("update",{delta:e}),this}},{key:"drop",value:function(){var e=this.unmerge(o.parseArgList.apply(null,arguments));return this.emit("update",{delta:e}),this}},{key:"empty",value:function(){var e=clone(this.data);this.data={},this.emit("update",{delta:e})}},{key:"transfer",value:function(e){var t=o.parseArgList.apply(null,[].slice.call(arguments).slice(1));if(!o.is(e))throw new TypeError("target inventory is not an inventory instance");var n=this.unmerge(t);return e.merge(n),this.emit("update",{target:e,delta:n}),this}},{key:"isEmpty",value:function(){return 0===this.length}},{key:"iterate",value:function(e){var t=this;return"function"!=typeof e||this.list.forEach((function(n){e(n,t.data[n])})),this}},{key:"use",value:function(t){if(e.has(t)){var n=e.get(t);if(n.use(),n.consumable){o.change(this,t,1,!0);var i={};i[t]=1,this.emit("update",{delta:i})}return this.emit("use",{item:n}),this}}},{key:"clone",value:function(){return new o(this.data||{},this.tags||[])}},{key:"toJSON",value:function(){return JSON.reviveWrapper("new setup.Inventory("+JSON.stringify(this.data)+", "+JSON.stringify(this.tags)+")")}}],[{key:"confirm",get:function(){return t},set:function(e){t="string"==typeof e&&"all"===e.trim().toLowerCase()?"all":!!e}},{key:"emptyMessage",get:function(){return n},set:function(e){"string"==typeof e&&(n=e)}},{key:"change",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(0!==n){if(e instanceof o&&(e=e.data),"object"!==_typeof(e)){if(e)throw new TypeError("cannot access inventory data");e={}}if(!a(t))throw new TypeError("invalid item name/id");if("number"==typeof n&&!Number.isNaN(n)&&Number.isInteger(n)||(n=1),s&&(n*=-1),n>0){if(Object.keys(e).includes(t)&&i(t))return;Object.keys(e).includes(t)||(e[t]=0),e[t]+=n}else{if(r(t))return;Object.keys(e).includes(t)&&"number"==typeof e[t]&&(e[t]+=n),e[t]<=0&&delete e[t]}return e}}},{key:"itemset",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(o.is(e)&&(e=e.data),"object"!==_typeof(e))return{};var t={};return Object.keys(e).forEach((function(n){"number"==typeof e[n]&&Number.isInteger(e[n])&&0!==e[n]&&(t[n]=e[n])})),t}},{key:"parseArgList",value:function(){var e=[].slice.call(arguments).flat(1/0);if(e.length%2!=0)throw new Error("item sets should be pairs of item IDs and numbers");var t={};return e.forEach((function(n,i){i%2==0&&(t[n]=e[i+1])})),t}},{key:"is",value:function(e){return e instanceof o}},{key:"emit",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};$(document).trigger(Object.assign({type:":inventory-"+e+".simple-inventory",inventory:t,target:null,delta:{},item:null},n))}},{key:"create",value:function(e,t){return new o(e,t)}}]),o}();setup.Inventory=o,window.Inventory=window.Inventory||o}(),function(){var e=setup.Item,t=setup.Inventory;function n(t){return e.has(t)&&e.get(t).permanent}function i(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"Alert",a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"Are you sure?";if(t.confirm||!e||"function"!=typeof e)if("all"!==t.confirm||i){var o={display:"inline-block",float:"right"},s=$(document.createElement("div")),u=$(document.createElement("p")).append(a),l=$(document.createElement("div")).addClass("confirmation-buttons"),c=$(document.createElement("button")).append("Okay").addClass("confirm-yes").css(Object.assign(o,{"margin-right":"0.5rem"})),d=$(document.createElement("button")).append("Cancel").addClass("confirm-no").css(o);e&&"function"==typeof e&&c.ariaClick(e),n&&"function"==typeof n&&d.ariaClick(n),l.append(d,c),s.append(u,l),Dialog.setup(r,"simple-inventory confirmation"),Dialog.append(s),Dialog.open()}else e();else e()}function r(e){var t=$(document.createElement("span")).addClass("spacer");return e&&t.wiki(e),t}function a(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"Inspect",r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return $(document.createElement(r?"button":"a")).addClass("inspect-link").wiki(i).ariaClick((function(){e.get(n).inspect()}))}function o(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"Use",i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return $(document.createElement(i?"button":"a")).addClass("use-link").wiki(n).ariaClick((function(){e.use(t)}))}function s(e,n,r){var a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return $(document.createElement(a?"button":"a")).addClass("drop-link").wiki(r||(o?"Give":"Drop")).ariaClick((function(){i((function(){o&&t.is(o)?e.transfer(o,n,1):e.drop(n,1),Dialog.close()}),(function(){Dialog.close()}))}))}function u(e,n){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return $(document.createElement(r?"button":"a")).addClass("all-link drop-link").wiki((n||(a?"Give":"Drop"))+" all").ariaClick((function(){e.isEmpty()||i((function(){a&&t.is(a)?(a.merge(e),e.empty()):e.empty(),Dialog.close()}),(function(){Dialog.close()}),!0)}))}function l(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"&nbsp;&times;&nbsp;",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"&nbsp;";return $(document.createElement("span")).addClass("item-count").append(""+n+(e.count(t)||0)+i)}function c(i){var c,d=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{description:!0,use:!0,transfer:null,drop:!0,all:!0,dropActionText:"",classes:""},f=$(document.createElement("ul")).addClass("simple-inventory-list");if(i.length){if(c=i.list.map((function(u){var c=[];return d.description&&e.has(u)&&e.get(u).description?c.push(a(i,u,e.has(u)?e.get(u).name:u)):c.push($(document.createElement("span")).append(e.has(u)?e.get(u).name:u).addClass("item-name")),c.push(l(i,u)),d.use&&e.has(u)&&e.get(u).handler?c.push(o(i,u)):c.push(r()),(d.transfer&&t.is(d.transfer)||d.drop)&&!n(u)?c.push(s(i,u,d.dropActionText,!1,d.target||null)):c.push(r()),$(document.createElement("li")).append(c).addClass("simple-inventory-listing")})),d.all){var h=$(document.createElement("li")).addClass("all-listing simple-inventory-listing").append([r("&mdash;"),r(),r(),u(i,d.dropActionText,!1,d.target||null)]);c.push(h)}}else c=$(document.createElement("li")).addClass("simple-inventory-listing").append($(document.createElement("span")).wiki(t.emptyMessage));return f.append(c),f}t.prototype.interface=function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=this,r=$(document.createElement("div")).addClass("simple-inventory-wrapper");return r.append(c(this,t)),$(document).on(":inventory-update.simple-inventory.gui-built-in",(function(){r.length?r.empty().append(c(i,t)):$(document).off(":inventory-update.simple-inventory.gui-built-in")})),n&&n instanceof $?e=n:n&&(e=$(n)),e&&r.appendTo(e),r}}(),function(){setup.Inventory,setup.Item;var e=".simple-inventory-userland",t=":inventory-update.simple-inventory"+e,n=":inventory-use.simple-inventory"+e;function i(e){return e&&"function"==typeof e}Object.assign(setup.Inventory,{events:{update:{on:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";i(e)&&$(document).on(t+n,e)},one:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";i(e)&&$(document).one(t+n,e)},off:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";$(document).off(t+e)}},use:{on:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";i(e)&&$(document).on(n+t,e)},one:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";i(e)&&$(document).one(n+t,e)},off:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";$(document).off(n+e)}}}})}(),function(){var e=setup.Item,t=setup.Inventory;function n(e){return e&&"string"==typeof e&&e.length>2&&("$"===e[0]||"_"===e[0])}function i(e){if(n(e)&&(e=State.getVar(e)),t.is(e))return e}Macro.add(["item","consumable"],{tags:["description","tags","unique","permanent"],handler:function(){var t,n,i,r,a=null,o=!1,s=!1,u=!1;if(State.length>0)return this.error("items must be defined in `StoryInit` or story JavaScript!");if(!this.args[0]||"string"!=typeof this.args[0]||!this.args[0].trim())return this.error("invalid item ID");if(t=this.args[0].trim(),"consumable"===this.name&&(a=this.payload[0].contents||null,o=!0),this.args[1]&&(n=this.args[1]),this.payload.length>1){var l=this.payload.find((function(e){return"description"===e.name})),c=this.payload.find((function(e){return"tags"===e.name})),d=this.payload.find((function(e){return"unique"===e.name})),f=this.payload.find((function(e){return"permanent"===e.name}));l&&(i=l.contents),c&&(r=c.args.flat(1/0)),d&&(s=!0),f&&(u=!0)}e.add(t,{displayName:n||"",description:i||"",handler:a,consumable:o,unique:s,permanent:u},r)}}),Macro.add("newinv",{handler:function(){var e=this.args.raw.trim().split(" ").first().replace(/["']/g,"").trim();if(!n(e))return this.error("argument must be a story or temporary variable!");State.setVar(e,new t({},this.args.flat(1/0).slice(1)))}}),Macro.add(["pickup","drop"],{handler:function(){var e=i(this.args[0]);return e?this.args.length<3?this.error("no items to pick up were provided"):void e[this.name](this.args.slice(1)):this.error("first argument must be a valid inventory!")}}),Macro.add("dropall",{handler:function(){var e=i(this.args[0]);if(!e)return this.error("first argument must be a valid inventory!");e.empty()}}),Macro.add(["transfer","merge","unmerge"],{handler:function(){var e=i(this.args[0]);if(!e)return this.error("first argument must be a valid inventory!");var t=i(this.args[1]);if(!t)return this.error("second argument must be a valid inventory!");if("transfer"===this.name){if(this.args.length<4)return this.error("no items to transfer were provided");e.transfer(t,this.args.slice(2))}else e[this.name](t)}}),Macro.add(["inv","take","give"],{handler:function(){var e=null,t=i(this.args[0]);if(!t)return this.error("first argument must be a valid inventory!");this.args[1]&&i(this.args[1])&&(e=i(this.args[1]));var n={description:this.args.includesAny("inspect","description"),use:this.args.includes("use"),transfer:e,drop:this.args.includes("drop"),all:this.args.includes("all"),dropActionText:"inv"===this.name?"Drop":this.name.toUpperFirst(),classes:"macro-".concat(this.name)};t.interface(n,$(this.output))}})}(),function(){var e=setup.Item,t=setup.Inventory;function n(e,t,n){if("object"!==_typeof(t))throw new TypeError("the extension should be a plain generic object holding the properties and methods you want to add");Object.keys(t).forEach((function(i){if(e[i]&&!n)throw new Error('Cannot override existing property "'+i+'"!');e[i]=t[i]}))}Object.assign(t,{extend:function(e){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];n(t,e,i)},extendPrototype:function(e){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];n(t.prototype,e,i)}}),Object.assign(e,{extend:function(t){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];n(e,t,i)},extendPrototype:function(t){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];n(e.prototype,t,i)}})}();
// End Simple Inventory
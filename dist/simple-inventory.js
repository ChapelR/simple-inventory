// Simple Inventory, for SugarCube 2, by Chapel
// v3.0.0-pa1, 2021-04-15, 60e4ce9ef72735d1e85effd48abffd6c508953a4
;(()=>{"use strict";const t={description:"",handler:null,displayName:"",consumable:!0,unique:!1,permanent:!1},e=new Map;class n{constructor(e="",n=clone(t),i=[]){if(!e||"string"!=typeof e)throw new Error("invalid item ID");if("object"!=typeof n)throw new Error("invalid item definition");Object.assign(this,Object.assign(t,n)),this.id=e,this.tags=i instanceof Array?i:"string"==typeof i?[i]:[]}static is(t){return t instanceof n}static add(t,i,s){const r=new n(t,i,s);return e.set(t,r),r}static get(t){return e.get(t)}static has(t){return e.has(t)}static get list(){return e}get name(){return this.displayName||this.id}set name(t){this.displayName=t}use(){return"string"==typeof this.handler?$.wiki(this.handler):"function"==typeof this.handler&&this.handler(this),this}inspect(){Dialog.setup(this.name,"simple-inventory item-description"),Dialog.wiki(this.description),Dialog.open()}}Macro.add(["item","consumable"],{tags:["description","tags","unique","permanent"],handler(){let t,e,i,s,r=null,a=!1,o=!1,u=!1;if(State.length>0)return this.error("items must be defined in `StoryInit` or story JavaScript!");if(!this.args[0]||"string"!=typeof this.args[0]||!this.args[0].trim())return this.error("invalid item ID");if(t=this.args[0].trim(),"consumable"===this.name&&(r=this.payload[0].contents||null,a=!0),this.args[1]&&(e=this.args[1]),this.payload.length>1){const t=this.payload.find((t=>"description"===t.name)),e=this.payload.find((t=>"tags"===t.name)),n=this.payload.find((t=>"unique"===t.name)),r=this.payload.find((t=>"permanent"===t.name));t&&(i=t.contents),e&&(s=e.args.flat(1/0)),n&&(o=!0),r&&(u=!0)}n.add(t,{displayName:e||"",description:i||"",handler:r,consumable:a,unique:o,permanent:u},s)}}),setup.Item=n,window.Item=window.Item||n})(),(()=>{"use strict";const t=setup.Item;function e(e){return t.has(e)&&t.get(e).permanent}class n{constructor(t={},e=[]){this.data=clone(t),this.tags=e instanceof Array?e:"string"==typeof e?[e]:[]}static change(i,s,r=1,a=!1){if(0!==r){if(i instanceof n&&(i=i.data),"object"!=typeof i){if(i)throw new TypeError("cannot access inventory data");i={}}if(!(o=s)||"string"!=typeof o||!o.trim())throw new TypeError("invalid item name/id");var o;if("number"==typeof r&&!Number.isNaN(r)&&Number.isInteger(r)||(r=1),a&&(r*=-1),r>0){if(Object.keys(i).includes(s)&&function(e){return t.has(e)&&t.get(e).unique}(s))return;Object.keys(i).includes(s)||(i[s]=0),i[s]+=r}else{if(e(s))return;Object.keys(i).includes(s)&&"number"==typeof i[s]&&(i[s]+=r),i[s]<=0&&delete i[s]}return i}}static itemset(t={}){if("object"!=typeof t)return{};const e={};return Object.keys(t).forEach((n=>{"number"==typeof t[n]&&Number.isInteger(t[n])&&0!==t[n]&&(e[n]=t[n])})),e}static is(t){return t instanceof n}static emit(t,e,n=null,i){$(document).trigger({type:":inventory-"+t+".simple-inventory",inventory:e,target:n,item:"use"===t&&i?i:void 0})}static add(t,e){return new n(t,e)}emit(t,e=null,i){return n.emit(t,this,e,i),this}get array(){const t=[];return Object.keys(this.data).forEach((e=>{if(t.push(e),this.data[e]>1)for(var n=1;n<this.data[e];n++)t.push(e)})),t}get list(){return Object.keys(this.data)}get length(){return this.array.length}get uniqueLength(){return this.list.length}get table(){return this.data}count(t){return t?this.data[t]||0:this.length}has(t,e=1){return this.data[t]>=e}hasAll(){const t=this;return[].slice.call(arguments).flat(1/0).every((e=>t.has(e)))}hasAny(){const t=this;return[].slice.call(arguments).flat(1/0).some((e=>t.has(e)))}pickup(t,e){return n.change(this,t,e)&&this.emit("update"),this}pickUp(t,e){return this.pickup(t,e)}drop(t,e){return n.change(this,t,e,!0)&&this.emit("update"),this}merge(t){const e=this,i=n.itemset(t);Object.keys(i).forEach((t=>{n.change(e,t,i[t])}))}empty(){this.data={},this.emit("update")}transfer(t,e,i){if(!n.is(t))throw new TypeError("target inventory is not an inventory instance");if(this.has(e)){const s=n.change(this,e,i,!0),r=n.change(t,e,i);(s||r)&&this.emit("update")}return this}isEmpty(){return 0===this.length}iterate(t){return"function"!=typeof t||this.list.forEach((e=>{t(e,this.data[e])})),this}use(e){if(!t.has(e))return;const i=t.get(e);return i.use(),i.consumable&&(n.change(this,e,1,!0),this.emit("update")),this.emit("use",null,i),this}inspectLink(e,n="Inspect",i=!1){return $(document.createElement(i?"button":"a")).addClass("inspect-link","simple-inventory").wiki(n).ariaClick((()=>{t.get(e).inspect()}))}useLink(t,e="Use",n=!1){const i=this;return $(document.createElement(n?"button":"a")).addClass("use-link","simple-inventory").wiki(e).ariaClick((()=>{i.use(t)}))}dropLink(t,e,i=!1,s=null){const r=this;return $(document.createElement(i?"button":"a")).addClass("drop-link","simple-inventory").wiki(e||(s?"Give":"Drop")).ariaClick((()=>{s&&n.is(s)?r.transfer(s,t):r.drop(t)}))}itemCount(t,e="&nbsp;&times;&nbsp;",n="&nbsp;"){return $(document.createElement("span")).addClass("item-count","simple-inventory").append(""+e+(this.count(t)||0)+n)}displayInventoryList(i={description:!0,use:!0,transfer:null,drop:!0,dropActionText:""}){const s=this,r=$(document.createElement("ul")).addClass("simple-inventory-list"),a=this.list.map((r=>{const a=[];return i.description&&t.has(r)&&t.get(r).description?a.push(s.inspectLink(r,t.has(r)?t.get(r).name:r)):a.push($(document.createElement("span")).append(t.has(r)?t.get(r).name:r).addClass("item-name")),a.push(s.itemCount(r)),i.use&&t.has(r)&&t.get(r).handler?a.push(s.useLink(r)):a.push($(document.createElement("span")).addClass("spacer")),(i.transfer&&n.is(i.transfer)||i.drop)&&!e(r)?(console.log(i.target,i.dropActionText),a.push(s.dropLink(r,i.dropActionText,!1,i.target||null))):a.push($(document.createElement("span")).addClass("spacer")),$(document.createElement("li")).append(a).addClass("simple-inventory-listing")}));return r.append(a),r}interface(t={},e=null){const n=$(document.createElement("div")).addClass("simple-inventory-wrapper");let i;return n.append(this.displayInventoryList(t)),$(document).on(":inventory-update.simple-inventory.gui-built-in",(()=>{n.length?n.empty().append(this.displayInventoryList(t)):$(document).off(":inventory-update.simple-inventory.gui-built-in")})),e&&e instanceof $?i=e:e&&(i=$(e)),i&&n.appendTo(i),n}clone(){return new n(this.data||{},this.tags||[])}toJSON(){return JSON.reviveWrapper("new setup.Inventory("+JSON.stringify(this.data)+", "+JSON.stringify(this.tags)+")")}}function i(t){return t&&"string"==typeof t&&t.length>2&&("$"===t[0]||"_"===t[0])}function s(t){if(i(t)&&(t=State.getVar(t)),n.is(t))return t}Macro.add("newinv",{handler(){const t=this.args.raw.trim().split(" ").first().replace(/["']/g,"").trim();if(!i(t))return this.error("argument must be a story or temporary variable!");State.setVar(t,new n({},this.args.flat(1/0).slice(1)))}}),Macro.add("pickup",{handler(){const t=s(this.args[0]);if(!t)return this.error("first argument must be a valid inventory!");t.pickup(this.args[1],this.args[2])}}),Macro.add("drop",{handler(){const t=s(this.args[0]);if(!t)return this.error("first argument must be a valid inventory!");t.drop(this.args[1],this.args[2])}}),Macro.add("transfer",{handler(){const t=s(this.args[0]);if(!t)return this.error("first argument must be a valid inventory!");const e=s(this.args[1]);if(!e)return this.error("second argument must be a valid inventory!");t.transfer(e,this.args[2],this.args[3])}}),Macro.add(["inv","take","give"],{handler(){let t=null;const e=s(this.args[0]);if(!e)return this.error("first argument must be a valid inventory!");this.args[1]&&s(this.args[1])&&(t=s(this.args[1]));const n={description:this.args.includesAny("inspect","description"),use:this.args.includes("use"),transfer:t,drop:this.args.includes("drop"),dropActionText:"inv"===this.name?"Drop":this.name.toUpperFirst()};e.interface(n,$(this.output))}}),setup.Inventory=n,window.Inventory=window.Inventory||n})(),(()=>{"use strict";setup.Inventory,setup.Item;const t=".simple-inventory-userland",e={update:":inventory-update.simple-inventory"+t,use:":inventory-use.simple-inventory"+t};function n(t){return t&&"function"==typeof t}Object.assign(setup.Inventory,{events:{update:{on(t=null,i=""){n(t)&&$(document).on(e.update+i,t)},one(t=null,i=""){n(t)&&$(document).one(e.update+i,t)},off(t=""){$(document).off(e.update+t)}},use:{on(t=null,i=""){n(t)&&$(document).on(e.use+i,t)},one(t=null,i=""){n(t)&&$(document).one(e.use+i,t)},off(t=""){$(document).off(e.use+t)}},on(t="update",i=null,s=""){n(i)&&e[t]&&$(document).on(e[t]+s,i)},one(t="update",i=null,s=""){n(i)&&e[t]&&$(document).one(e[t]+s,i)},off(t="update",n=""){e[t]&&$(document).off(e[t]+n)}}})})();
// End Simple Inventory